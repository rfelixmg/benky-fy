{% extends 'base.html' %}
{% block title %}Module 1 | Benkyo-Fi{% endblock %}
{% block content %}
<section class="panel">
	<div class="header-with-settings">
		<h1>Flashcards + Typing</h1>
		<div class="settings-dropdown">
			<button class="settings-btn" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
			<div class="settings-panel" id="settingsPanel">
				<form method="POST" action="{{ url_for('module1.update_settings') }}">
					<div class="settings-section">
						<h3>Flashcard Style:</h3>
						<div class="checkbox-group">
							<label><input type="checkbox" name="flashcard_hiragana" {% if 'hiragana' in settings.flashcard_styles %}checked{% endif %}> Hiragana</label>
							<label><input type="checkbox" name="flashcard_kanji" {% if 'kanji' in settings.flashcard_styles %}checked{% endif %}> Kanji</label>
							<label><input type="checkbox" name="flashcard_katakana" {% if 'katakana' in settings.flashcard_styles %}checked{% endif %}> Katakana</label>
							<label><input type="checkbox" name="flashcard_english" {% if 'english' in settings.flashcard_styles %}checked{% endif %}> English</label>
						</div>
					</div>
					<div class="settings-section">
						<h3>Checking Style:</h3>
						<div class="checkbox-group">
							<label><input type="checkbox" name="checking_hiragana" {% if 'hiragana' in settings.checking_styles %}checked{% endif %}> Hiragana <span class="note">(type romaji, converts to hiragana)</span></label>
							<label><input type="checkbox" name="checking_romaji" {% if 'romaji' in settings.checking_styles %}checked{% endif %}> Romaji <span class="note">(type romaji, stays as romaji)</span></label>
							<label><input type="checkbox" name="checking_kanji" {% if 'kanji' in settings.checking_styles %}checked{% endif %}> Kanji</label>
							<label><input type="checkbox" name="checking_katakana" {% if 'katakana' in settings.checking_styles %}checked{% endif %}> Katakana</label>
							<label><input type="checkbox" name="checking_english" {% if 'english' in settings.checking_styles %}checked{% endif %}> English</label>
						</div>
					</div>
					<div class="settings-actions">
						<button type="submit" class="btn btn-small">Save Settings</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	<div class="prompt">
		<p class="muted">Prompt ({{ item.prompt_script }})</p>
		<div class="prompt-value">{{ item.prompt }}</div>
	</div>
	<form class="answer-form" method="POST" action="{{ url_for('module1.module1_check') }}">
		<div class="input-row">
			{% set has_hiragana_romaji = 'hiragana' in settings.checking_styles or 'romaji' in settings.checking_styles %}
			{% set other_styles = settings.checking_styles | reject('in', ['hiragana', 'romaji']) | list %}
			
			{% if has_hiragana_romaji %}
			<div class="input-group">
				{% set hiragana_label = 'hiragana' in settings.checking_styles %}
				{% set romaji_label = 'romaji' in settings.checking_styles %}
				<label for="user_hiragana_romaji">
					Your answer (
					{%- if hiragana_label and romaji_label -%}
						hiragana/romaji
					{%- elif hiragana_label -%}
						hiragana
					{%- else -%}
						romaji
					{%- endif -%}
					):
				</label>
				<input type="text" id="user_hiragana_romaji" name="user_hiragana_romaji" class="answer-input" placeholder="Type in romaji..." autofocus />
			</div>
			{% endif %}
			
			{% for style in other_styles %}
			<div class="input-group">
				<label for="user_{{ style }}">Your answer ({{ style }}):</label>
				<input type="text" id="user_{{ style }}" name="user_{{ style }}" class="answer-input" placeholder="Type {{ style }}..." {% if not has_hiragana_romaji and loop.first %}autofocus{% endif %} />
			</div>
			{% endfor %}
		</div>	
		<input type="hidden" id="item_id" name="item_id" value="{{ item.index }}">
	
		<div class="actions">
			<button type="submit" class="btn">Reveal üåü</button>
		</div>
	</form>
	
	{% if results is not none %}
	<div class="results-container">
		<div class="overall-result {{ 'correct' if all_correct else 'incorrect' }}">
			<p><strong>{{ 'All Correct!' if all_correct else 'Some Incorrect' }}</strong></p>
		</div>
		
				{% for style, result in results.items() %}
		<div class="result {{ 'correct' if result.is_correct else 'incorrect' }}">
			<h4>{{ style.title() }}</h4>
			{% if style == 'hiragana' and result.user_input_converted %}
			<p>Your input: <code>{{ result.user_input or '(empty)' }}</code></p>
			<p>Converted to hiragana: <code>{{ result.user_input_converted }}</code></p>
			{% else %}
			<p>Your answer: <code>{{ result.user_input or '(empty)' }}</code></p>
			{% endif %}
			<p>Correct answer: <code>{{ result.correct_answer }}</code></p>
			<p class="result-status">{{ '‚úì Correct' if result.is_correct else '‚úó Incorrect' }}</p>
		</div>
		{% endfor %}
	</div>

	<button class="btn" onclick="goToNext()">
		Next ‚û°Ô∏è
	</button>

	<script>
	document.addEventListener("keydown", function(e) {
		if (e.key === "Enter") {
			const resultBox = document.querySelector(".results-container");
			if (resultBox) {
				// prevent submitting the form again
				e.preventDefault();
				// go to next card
				goToNext();
			}
		}
	});
	
	function toggleSettings() {
		const panel = document.getElementById('settingsPanel');
		panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
	}
	
	function goToNext() {
		window.location.href = "{{ url_for('module1.module1_index') }}";
	}
	
	// Close settings panel when clicking outside
	document.addEventListener('click', function(e) {
		const settingsDropdown = document.querySelector('.settings-dropdown');
		const settingsPanel = document.getElementById('settingsPanel');
		if (!settingsDropdown.contains(e.target)) {
			settingsPanel.style.display = 'none';
		}
	});
	</script>
	{% endif %}
  
  
</section>
{% endblock %}


