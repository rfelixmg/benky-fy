{% extends 'base.html' %}
{% block title %}Module 1 | Benkyo-Fi{% endblock %}
{% block content %}
<section class="panel">
	<div class="header-with-settings">
		<h1>Flashcards + Typing</h1>
		<div class="settings-dropdown">
			<button class="settings-btn" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
			<div class="settings-panel" id="settingsPanel">
				<form method="POST" action="{{ url_for('module1.update_settings') }}">
					<div class="settings-section">
						<h3>Flashcard Style:</h3>
						<div class="checkbox-group">
							<label><input type="checkbox" name="flashcard_hiragana" {% if 'hiragana' in settings.flashcard_styles %}checked{% endif %}> Hiragana</label>
							<label><input type="checkbox" name="flashcard_kanji" {% if 'kanji' in settings.flashcard_styles %}checked{% endif %}> Kanji</label>
							<label><input type="checkbox" name="flashcard_katakana" {% if 'katakana' in settings.flashcard_styles %}checked{% endif %}> Katakana</label>
							<label><input type="checkbox" name="flashcard_english" {% if 'english' in settings.flashcard_styles %}checked{% endif %}> English</label>
						</div>
					</div>
					<div class="settings-section">
						<h3>Checking Style:</h3>
						<div class="checkbox-group">
							<label><input type="checkbox" name="checking_hiragana" {% if 'hiragana' in settings.checking_styles %}checked{% endif %}> Hiragana <span class="note">(converts romaji ‚Üí hiragana as you type)</span></label>
							<label><input type="checkbox" name="checking_romaji" {% if 'romaji' in settings.checking_styles %}checked{% endif %}> Romaji <span class="note">(keeps romaji as you type)</span></label>
							<label><input type="checkbox" name="checking_kanji" {% if 'kanji' in settings.checking_styles %}checked{% endif %}> Kanji</label>
							<label><input type="checkbox" name="checking_katakana" {% if 'katakana' in settings.checking_styles %}checked{% endif %}> Katakana</label>
							<label><input type="checkbox" name="checking_english" {% if 'english' in settings.checking_styles %}checked{% endif %}> English</label>
						</div>
					</div>
					<div class="settings-actions">
						<button type="submit" class="btn btn-small">Save Settings</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	<div class="prompt">
		<p class="muted">Prompt ({{ item.prompt_script }})</p>
		<div class="prompt-value">{{ item.prompt }}</div>
	</div>
	<form class="answer-form" method="POST" action="{{ url_for('module1.module1_check') }}">
		<div class="input-row">
			{% set has_hiragana_romaji = 'hiragana' in settings.checking_styles or 'romaji' in settings.checking_styles %}
			{% set other_styles = settings.checking_styles | reject('in', ['hiragana', 'romaji']) | list %}
			
			{% if has_hiragana_romaji %}
			<div class="input-group">
				{% set hiragana_label = 'hiragana' in settings.checking_styles %}
				{% set romaji_label = 'romaji' in settings.checking_styles %}
				<label for="user_hiragana_romaji">
					Your answer (
					{%- if hiragana_label and romaji_label -%}
						hiragana/romaji
					{%- elif hiragana_label -%}
						hiragana
					{%- else -%}
						romaji
					{%- endif -%}
					):
				</label>
				<input type="text" 
					   id="user_hiragana_romaji" 
					   name="user_hiragana_romaji" 
					   class="answer-input" 
					   placeholder="Type in romaji..." 
					   autofocus 
					   autocomplete="off" 
					   autocorrect="off" 
					   autocapitalize="off" 
					   spellcheck="false" />
			</div>
			{% endif %}
			
			{% for style in other_styles %}
			<div class="input-group">
				<label for="user_{{ style }}">Your answer ({{ style }}):</label>
				<input type="text" 
					   id="user_{{ style }}" 
					   name="user_{{ style }}" 
					   class="answer-input" 
					   placeholder="Type {{ style }}..." 
					   autocomplete="off" 
					   autocorrect="off" 
					   autocapitalize="off" 
					   spellcheck="false" />
			</div>
			{% endfor %}
		</div>	
		<input type="hidden" id="item_id" name="item_id" value="{{ item.index }}">
	
		<div class="actions">
			<button type="submit" class="btn">Reveal üåü</button>
		</div>
	</form>
	
	{% if results is not none %}
	<div class="results-container">
		<div class="overall-result {{ 'correct' if all_correct else 'incorrect' }}">
			<p><strong>{{ 'All Correct!' if all_correct else 'Some Incorrect' }}</strong></p>
		</div>
		
				{% for style, result in results.items() %}
		<div class="result {{ 'correct' if result.is_correct else 'incorrect' }}">
			<h4>{{ style.title() }}</h4>
			<p>Your answer: <code>{{ result.user_input or '(empty)' }}</code></p>
			<p>Correct answer: <code>{{ result.correct_answer }}</code></p>
			<p class="result-status">{{ '‚úì Correct' if result.is_correct else '‚úó Incorrect' }}</p>
		</div>
		{% endfor %}
	</div>

	<button class="btn" onclick="goToNext()">
		Next ‚û°Ô∏è
	</button>

	{% endif %}
  
  
</section>

<script>
document.addEventListener("keydown", function(e) {
	if (e.key === "Enter") {
		const resultBox = document.querySelector(".results-container");
		if (resultBox) {
			// prevent submitting the form again
			e.preventDefault();
			// go to next card
			goToNext();
		}
	}
});

function toggleSettings() {
	const panel = document.getElementById('settingsPanel');
	panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
}

function goToNext() {
	window.location.href = "{{ url_for('module1.module1_index') }}";
}

// Close settings panel when clicking outside
document.addEventListener('click', function(e) {
	const settingsDropdown = document.querySelector('.settings-dropdown');
	const settingsPanel = document.getElementById('settingsPanel');
	if (!settingsDropdown.contains(e.target)) {
		settingsPanel.style.display = 'none';
	}
});

// Romaji to Hiragana conversion mapping
const romajiToHiragana = {
	'a': '„ÅÇ', 'i': '„ÅÑ', 'u': '„ÅÜ', 'e': '„Åà', 'o': '„Åä',
	'ka': '„Åã', 'ki': '„Åç', 'ku': '„Åè', 'ke': '„Åë', 'ko': '„Åì',
	'ga': '„Åå', 'gi': '„Åé', 'gu': '„Åê', 'ge': '„Åí', 'go': '„Åî',
	'sa': '„Åï', 'shi': '„Åó', 'su': '„Åô', 'se': '„Åõ', 'so': '„Åù',
	'za': '„Åñ', 'ji': '„Åò', 'zu': '„Åö', 'ze': '„Åú', 'zo': '„Åû',
	'ta': '„Åü', 'chi': '„Å°', 'tsu': '„Å§', 'te': '„Å¶', 'to': '„Å®',
	'da': '„Å†', 'di': '„Å¢', 'du': '„Å•', 'de': '„Åß', 'do': '„Å©',
	'na': '„Å™', 'ni': '„Å´', 'nu': '„Å¨', 'ne': '„Å≠', 'no': '„ÅÆ',
	'ha': '„ÅØ', 'hi': '„Å≤', 'fu': '„Åµ', 'he': '„Å∏', 'ho': '„Åª',
	'ba': '„Å∞', 'bi': '„Å≥', 'bu': '„Å∂', 'be': '„Åπ', 'bo': '„Åº',
	'pa': '„Å±', 'pi': '„Å¥', 'pu': '„Å∑', 'pe': '„Å∫', 'po': '„ÅΩ',
	'ma': '„Åæ', 'mi': '„Åø', 'mu': '„ÇÄ', 'me': '„ÇÅ', 'mo': '„ÇÇ',
	'ya': '„ÇÑ', 'yu': '„ÇÜ', 'yo': '„Çà',
	'ra': '„Çâ', 'ri': '„Çä', 'ru': '„Çã', 're': '„Çå', 'ro': '„Çç',
	'wa': '„Çè', 'wi': '„Çê', 'we': '„Çë', 'wo': '„Çí', 'n': '„Çì',
	// Common combinations
	'kya': '„Åç„ÇÉ', 'kyu': '„Åç„ÇÖ', 'kyo': '„Åç„Çá',
	'gya': '„Åé„ÇÉ', 'gyu': '„Åé„ÇÖ', 'gyo': '„Åé„Çá',
	'sha': '„Åó„ÇÉ', 'shu': '„Åó„ÇÖ', 'sho': '„Åó„Çá',
	'ja': '„Åò„ÇÉ', 'ju': '„Åò„ÇÖ', 'jo': '„Åò„Çá',
	'cha': '„Å°„ÇÉ', 'chu': '„Å°„ÇÖ', 'cho': '„Å°„Çá',
	'nya': '„Å´„ÇÉ', 'nyu': '„Å´„ÇÖ', 'nyo': '„Å´„Çá',
	'hya': '„Å≤„ÇÉ', 'hyu': '„Å≤„ÇÖ', 'hyo': '„Å≤„Çá',
	'bya': '„Å≥„ÇÉ', 'byu': '„Å≥„ÇÖ', 'byo': '„Å≥„Çá',
	'pya': '„Å¥„ÇÉ', 'pyu': '„Å¥„ÇÖ', 'pyo': '„Å¥„Çá',
	'mya': '„Åø„ÇÉ', 'myu': '„Åø„ÇÖ', 'myo': '„Åø„Çá',
	'rya': '„Çä„ÇÉ', 'ryu': '„Çä„ÇÖ', 'ryo': '„Çä„Çá'
};

function convertRomajiToHiragana(romajiText) {
	if (!romajiText) return "";
	
	romajiText = romajiText.toLowerCase().trim();
	let result = "";
	let i = 0;
	
	while (i < romajiText.length) {
		let found = false;
		
		// Try longer combinations first (3 chars, then 2, then 1)
		for (let length = 3; length >= 1; length--) {
			if (i + length <= romajiText.length) {
				const substring = romajiText.substring(i, i + length);
				if (romajiToHiragana[substring]) {
					result += romajiToHiragana[substring];
					i += length;
					found = true;
					break;
				}
			}
		}
		
		if (!found) {
			// If no mapping found, keep the original character
			result += romajiText[i];
			i++;
		}
	}
	
	return result;
}

// Setup real-time conversion for hiragana input
document.addEventListener('DOMContentLoaded', function() {
	const hiraganaRomajiInput = document.getElementById('user_hiragana_romaji');
	const checkingStyles = {{ settings.checking_styles | tojson }};
	const hasHiraganaChecking = checkingStyles.includes('hiragana');
	
	console.log('Input element found:', !!hiraganaRomajiInput);
	console.log('Checking styles:', checkingStyles);
	console.log('Has hiragana checking:', hasHiraganaChecking);
	
	if (hiraganaRomajiInput) {
		console.log('Setting up real-time conversion');
		
		// Test conversion function
		console.log('Test conversion: ka =', convertRomajiToHiragana('ka'));
		
		hiraganaRomajiInput.addEventListener('input', function(e) {
			console.log('Input event triggered, value:', e.target.value);
			
			// Only convert if hiragana checking is enabled
			if (!hasHiraganaChecking) {
				console.log('Hiragana checking not enabled, skipping conversion');
				return;
			}
			
			const cursorPos = e.target.selectionStart;
			const originalValue = e.target.value;
			const convertedValue = convertRomajiToHiragana(originalValue);
			
			console.log('Original:', originalValue, 'Converted:', convertedValue);
			
			if (convertedValue !== originalValue) {
				console.log('Updating value from', originalValue, 'to', convertedValue);
				e.target.value = convertedValue;
				
				// Try to maintain cursor position
				const newCursorPos = Math.min(cursorPos, convertedValue.length);
				setTimeout(() => {
					e.target.setSelectionRange(newCursorPos, newCursorPos);
				}, 0);
			}
		});
	} else {
		console.log('Input element not found!');
	}
});
</script>
{% endblock %}


