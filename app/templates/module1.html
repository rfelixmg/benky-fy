{% extends 'base.html' %}
{% block title %}Module 1 | Benkyo-Fi{% endblock %}
{% block content %}
<section class="panel">
	<div class="header-with-settings">
		<h1>Flashcards + Typing</h1>
		<div class="settings-dropdown">
			<button class="settings-btn" onclick="toggleSettings()">⚙️ Settings</button>
			<div class="settings-panel" id="settingsPanel">
				<form method="POST" action="{{ url_for('module1.update_settings') }}">
					<div class="settings-section">
						<h3>Flashcard Style:</h3>
						<div class="checkbox-group">
							<label><input type="checkbox" name="flashcard_hiragana" {% if 'hiragana' in settings.flashcard_styles %}checked{% endif %}> Hiragana</label>
							<label><input type="checkbox" name="flashcard_kanji" {% if 'kanji' in settings.flashcard_styles %}checked{% endif %}> Kanji</label>
							<label><input type="checkbox" name="flashcard_katakana" {% if 'katakana' in settings.flashcard_styles %}checked{% endif %}> Katakana</label>
							<label><input type="checkbox" name="flashcard_english" {% if 'english' in settings.flashcard_styles %}checked{% endif %}> English</label>
						</div>
					</div>
					<div class="settings-section">
						<h3>Checking Style:</h3>
						<div class="checkbox-group">
							<label><input type="checkbox" name="checking_hiragana" {% if 'hiragana' in settings.checking_styles %}checked{% endif %}> Hiragana <span class="note">(converts romaji → hiragana as you type)</span></label>
							<label><input type="checkbox" name="checking_romaji" {% if 'romaji' in settings.checking_styles %}checked{% endif %}> Romaji <span class="note">(keeps romaji as you type)</span></label>
							<label><input type="checkbox" name="checking_kanji" {% if 'kanji' in settings.checking_styles %}checked{% endif %}> Kanji</label>
							<label><input type="checkbox" name="checking_katakana" {% if 'katakana' in settings.checking_styles %}checked{% endif %}> Katakana</label>
							<label><input type="checkbox" name="checking_english" {% if 'english' in settings.checking_styles %}checked{% endif %}> English</label>
						</div>
					</div>
					<div class="settings-actions">
						<button type="submit" class="btn btn-small">Save Settings</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	<div class="prompt">
		<p class="muted">Prompt ({{ item.prompt_script }})</p>
		<div class="prompt-value">{{ item.prompt }}</div>
	</div>
	<div class="answer-form">
		{% set has_hiragana_romaji = 'hiragana' in settings.checking_styles or 'romaji' in settings.checking_styles %}
		{% set other_styles = settings.checking_styles | reject('in', ['hiragana', 'romaji']) | list %}
		
		{% if has_hiragana_romaji %}
		<div class="input-group">
			{% set hiragana_label = 'hiragana' in settings.checking_styles %}
			{% set romaji_label = 'romaji' in settings.checking_styles %}
			<label for="user_hiragana_romaji">
				Your answer (
				{%- if hiragana_label and romaji_label -%}
					hiragana/romaji
				{%- elif hiragana_label -%}
					hiragana
				{%- else -%}
					romaji
				{%- endif -%}
				):
			</label>
			<input type="text" 
				   id="user_hiragana_romaji" 
				   name="user_hiragana_romaji" 
				   class="answer-input" 
				   placeholder="Type in romaji..." 
				   autofocus 
				   autocomplete="off" 
				   autocorrect="off" 
				   autocapitalize="off" 
				   spellcheck="false" />
		</div>
		{% endif %}
		
		{% for style in other_styles %}
		<div class="input-group">
			<label for="user_{{ style }}">Your answer ({{ style }}):</label>
			<input type="text" 
				   id="user_{{ style }}" 
				   name="user_{{ style }}" 
				   class="answer-input" 
				   placeholder="Type {{ style }}..." 
				   autocomplete="off" 
				   autocorrect="off" 
				   autocapitalize="off" 
				   spellcheck="false" />
		</div>
		{% endfor %}
	</div>	
	<input type="hidden" id="item_id" name="item_id" value="{{ item.index }}">

	<div class="actions">
		<button type="button" class="btn" onclick="handleCheckAnswers()">benkyfy</button>
	</div>
	
	<!-- Always render the results container -->
	<div class="results-container">
		<!-- Initial content can be empty or a placeholder -->
	</div>

	{% if results is not none %}
	<div class="overall-result {{ 'correct' if all_correct else 'incorrect' }}">
		<p><strong>{{ 'All Correct!' if all_correct else 'Some Incorrect' }}</strong></p>
	</div>
		
				{% for style, result in results.items() %}
	<div class="result {{ 'correct' if result.is_correct else 'incorrect' }}">
		<h4>{{ style.title() }}</h4>
		<p>Your answer: <code>{{ result.user_input or '(empty)' }}</code></p>
		<p>Correct answer: <code>{{ result.correct_answer }}</code></p>
		<p class="result-status">{{ '✓ Correct' if result.is_correct else '✗ Incorrect' }}</p>
	</div>
	{% endfor %}

	<button class="btn" onclick="goToNext()">
		Next ➡️
	</button>

	{% endif %}
  
  
</section>

<script>
document.addEventListener("keydown", function(e) {
	if (e.key === "Enter") {
		const resultBox = document.querySelector(".results-container");
		if (resultBox) {
			// prevent submitting the form again
			e.preventDefault();
			// go to next card
			goToNext();
		}
	}
});

function toggleSettings() {
	const panel = document.getElementById('settingsPanel');
	panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
}

function goToNext() {
	window.location.href = "{{ url_for('module1.module1_index') }}";
}

// Close settings panel when clicking outside
document.addEventListener('click', function(e) {
	const settingsDropdown = document.querySelector('.settings-dropdown');
	const settingsPanel = document.getElementById('settingsPanel');
	if (!settingsDropdown.contains(e.target)) {
		settingsPanel.style.display = 'none';
	}
});

// Romaji to Hiragana conversion mapping
const romajiToHiragana = {
	'a': 'あ', 'i': 'い', 'u': 'う', 'e': 'え', 'o': 'お',
	'ka': 'か', 'ki': 'き', 'ku': 'く', 'ke': 'け', 'ko': 'こ',
	'ga': 'が', 'gi': 'ぎ', 'gu': 'ぐ', 'ge': 'げ', 'go': 'ご',
	'sa': 'さ', 'shi': 'し', 'su': 'す', 'se': 'せ', 'so': 'そ',
	'za': 'ざ', 'ji': 'じ', 'zu': 'ず', 'ze': 'ぜ', 'zo': 'ぞ',
	'ta': 'た', 'chi': 'ち', 'tsu': 'つ', 'te': 'て', 'to': 'と',
	'da': 'だ', 'di': 'ぢ', 'du': 'づ', 'de': 'で', 'do': 'ど',
	'na': 'な', 'ni': 'に', 'nu': 'ぬ', 'ne': 'ね', 'no': 'の',
	'ha': 'は', 'hi': 'ひ', 'fu': 'ふ', 'he': 'へ', 'ho': 'ほ',
	'ba': 'ば', 'bi': 'び', 'bu': 'ぶ', 'be': 'べ', 'bo': 'ぼ',
	'pa': 'ぱ', 'pi': 'ぴ', 'pu': 'ぷ', 'pe': 'ぺ', 'po': 'ぽ',
	'ma': 'ま', 'mi': 'み', 'mu': 'む', 'me': 'め', 'mo': 'も',
	'ya': 'や', 'yu': 'ゆ', 'yo': 'よ',
	'ra': 'ら', 'ri': 'り', 'ru': 'る', 're': 'れ', 'ro': 'ろ',
	'wa': 'わ', 'wi': 'ゐ', 'we': 'ゑ', 'wo': 'を', 'n': 'ん',
	// Common combinations
	'kya': 'きゃ', 'kyu': 'きゅ', 'kyo': 'きょ',
	'gya': 'ぎゃ', 'gyu': 'ぎゅ', 'gyo': 'ぎょ',
	'sha': 'しゃ', 'shu': 'しゅ', 'sho': 'しょ',
	'ja': 'じゃ', 'ju': 'じゅ', 'jo': 'じょ',
	'cha': 'ちゃ', 'chu': 'ちゅ', 'cho': 'ちょ',
	'nya': 'にゃ', 'nyu': 'にゅ', 'nyo': 'にょ',
	'hya': 'ひゃ', 'hyu': 'ひゅ', 'hyo': 'ひょ',
	'bya': 'びゃ', 'byu': 'びゅ', 'byo': 'びょ',
	'pya': 'ぴゃ', 'pyu': 'ぴゅ', 'pyo': 'ぴょ',
	'mya': 'みゃ', 'myu': 'みゅ', 'myo': 'みょ',
	'rya': 'りゃ', 'ryu': 'りゅ', 'ryo': 'りょ'
};

function convertRomajiToHiragana(romajiText) {
	if (!romajiText) return "";
	
	romajiText = romajiText.toLowerCase().trim();
	let result = "";
	let i = 0;
	
	while (i < romajiText.length) {
		let found = false;
		
		// Try longer combinations first (3 chars, then 2, then 1)
		for (let length = 3; length >= 1; length--) {
			if (i + length <= romajiText.length) {
				const substring = romajiText.substring(i, i + length);
				if (romajiToHiragana[substring]) {
					result += romajiToHiragana[substring];
					i += length;
					found = true;
					break;
				}
			}
		}
		
		if (!found) {
			// If no mapping found, keep the original character
			result += romajiText[i];
			i++;
		}
	}
	
	return result;
}

function fetchCorrectAnswers() {
    // Define the API endpoint
    const apiUrl = '/api/correct-answers'; // Replace with your actual API endpoint

    // Make the API request
    return fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Process the data to extract correct answers
            return {
                user_hiragana_romaji: data.hiragana_romaji,
                user_kanji: data.kanji,
                user_katakana: data.katakana,
                user_english: data.english
            };
        })
        .catch(error => {
            console.error('Error fetching correct answers:', error);
            return null;
        });
}

function handleCheckAnswers(event) {
    if (event) {
        event.preventDefault(); // Prevent default behavior
    }

    if (resultsShown) {
        resetOrNext();
        return;
    }

    // Retrieve user inputs
    const userInputs = {};
    const inputElements = document.querySelectorAll('.answer-input');
    inputElements.forEach(input => {
        userInputs[input.name] = input.value.trim();
    });

    // Fetch correct answers
    fetchCorrectAnswers().then(correctAnswers => {
        if (!correctAnswers) {
            console.error('Failed to fetch correct answers');
            return;
        }

        // Compare user inputs with correct answers
        const results = {};
        for (const [key, userInput] of Object.entries(userInputs)) {
            const correctAnswer = correctAnswers[key];
            results[key] = {
                user_input: userInput,
                correct_answer: correctAnswer,
                is_correct: userInput === correctAnswer
            };
        }

        // Update the UI with results
        const resultsContainer = document.querySelector('.results-container');
        if (!resultsContainer) {
            console.error('Results container not found!');
            return;
        }
        resultsContainer.style.display = 'block'; // Ensure it's visible
        resultsContainer.innerHTML = ''; // Clear previous results
        for (const [style, result] of Object.entries(results)) {
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${result.is_correct ? 'correct' : 'incorrect'}`;
            resultDiv.innerHTML = `
                <h4>${style.replace('user_', '').toUpperCase()}</h4>
                <p>Your answer: <code>${result.user_input || '(empty)'}</code></p>
                <p>Correct answer: <code>${result.correct_answer}</code></p>
                <p class="result-status">${result.is_correct ? '✓ Correct' : '✗ Incorrect'}</p>
            `;
            resultsContainer.appendChild(resultDiv);
        }

        resultsShown = true; // Set flag to true after showing results
    });
}

document.addEventListener('DOMContentLoaded', function() {
    let resultsShown = false; // Define resultsShown in the correct scope

    function resetOrNext() {
        console.log('Moving to next question or resetting inputs');
        // Example: Reset inputs
        const inputElements = document.querySelectorAll('.answer-input');
        inputElements.forEach(input => {
            input.value = '';
        });
        resultsShown = false; // Reset the flag
    }

    // Attach the function to the button click
    const button = document.querySelector('button[onclick="handleCheckAnswers()"]');
    if (button) {
        button.onclick = handleCheckAnswers;
    } else {
        console.error('Button not found!');
    }

    // Add event listener for the "Enter" key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            handleCheckAnswers(event); // Call the handleCheckAnswers function
        }
    });
});

// Setup real-time conversion for hiragana input
document.addEventListener('DOMContentLoaded', function() {
	const hiraganaRomajiInput = document.getElementById('user_hiragana_romaji');
	const checkingStyles = {{ settings.checking_styles | tojson }};
	const hasHiraganaChecking = checkingStyles.includes('hiragana');
	
	console.log('Input element found:', !!hiraganaRomajiInput);
	console.log('Checking styles:', checkingStyles);
	console.log('Has hiragana checking:', hasHiraganaChecking);
	
	if (hiraganaRomajiInput) {
		console.log('Setting up real-time conversion');
		
		// Test conversion function
		console.log('Test conversion: ka =', convertRomajiToHiragana('ka'));
		
		hiraganaRomajiInput.addEventListener('input', function(e) {
			console.log('Input event triggered, value:', e.target.value);
			
			// Only convert if hiragana checking is enabled
			if (!hasHiraganaChecking) {
				console.log('Hiragana checking not enabled, skipping conversion');
				return;
			}
			
			const cursorPos = e.target.selectionStart;
			const originalValue = e.target.value;
			const convertedValue = convertRomajiToHiragana(originalValue);
			
			console.log('Original:', originalValue, 'Converted:', convertedValue);
			
			if (convertedValue !== originalValue) {
				console.log('Updating value from', originalValue, 'to', convertedValue);
				e.target.value = convertedValue;
				
				// Try to maintain cursor position
				const newCursorPos = Math.min(cursorPos, convertedValue.length);
				setTimeout(() => {
					e.target.setSelectionRange(newCursorPos, newCursorPos);
				}, 0);
			}
		});
	} else {
		console.log('Input element not found!');
	}
});
</script>
{% endblock %}


